{% extends "base.html" %}

{% block title %}{{ client.name }}{% endblock %}

{% block extra_head %}
  <!-- Yandex Maps JS API -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=uz_UZ" type="text/javascript"></script>
  <style>
    #map { height: 360px; border-radius: 0.75rem; overflow: hidden; }
  </style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">

  <!-- Header + actions -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ client.name }}</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        Yaratilgan: {{ client.created_at|date:"Y-m-d H:i" }} · Yangilangan: {{ client.updated_at|date:"Y-m-d H:i" }}
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'clients:list' %}" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
        ← Ro‘yxatga qaytish
      </a>
      <a href="{% url 'clients:update' client.id %}" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        Tahrirlash
      </a>
      <a href="{% url 'clients:delete' client.id %}" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">
        O‘chirish
      </a>
    </div>
  </div>

  <!-- Info card -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 space-y-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Ism</div>
        <div class="font-medium text-gray-900 dark:text-gray-100">{{ client.name }}</div>
      </div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Telefon raqamlar</div>
        <div class="space-y-1">
          {% if client.phone_numbers.all %}
            {% for phone in client.phone_numbers.all %}
              <div>
                <a href="tel:{{ phone.phone_number }}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                  {{ phone.phone_number }}
                </a>
                {% if phone.is_primary %}
                  <span class="ml-1 px-1 bg-blue-100 text-blue-800 text-xs rounded">Asosiy</span>
                {% endif %}
                {% if phone.description %}
                  <span class="ml-1 text-sm text-gray-500">- {{ phone.description }}</span>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-gray-400">—</div>
          {% endif %}
        </div>
      </div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Latitude</div>
        <div id="lat-text" class="font-mono text-gray-900 dark:text-gray-100">
          {% if client.latitude %}{{ client.latitude|floatformat:6 }}{% else %}—{% endif %}
        </div>
      </div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Longitude</div>
        <div id="lon-text" class="font-mono text-gray-900 dark:text-gray-100">
          {% if client.longitude %}{{ client.longitude|floatformat:6 }}{% else %}—{% endif %}
        </div>
      </div>
    </div>

    <!-- Address line -->
    <div class="pt-2">
      <div class="text-sm text-gray-500 dark:text-gray-400">Manzil</div>
      <div id="addr-text" class="text-gray-900 dark:text-gray-100">
        {% if client.latitude and client.longitude %}
          Aniqlanmoqda…
        {% else %}
          Koordinata berilmagan
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Map -->
  {% if client.latitude and client.longitude %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
      <div id="map" class="bg-gray-200 dark:bg-gray-700"></div>
      <div class="mt-3 flex items-center gap-2">
        <a id="yandex-link" href="#" target="_blank"
           class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition text-sm">
          Yandex’da ko‘rish
        </a>
        <button id="copy-coord" type="button"
                class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm">
          Koordinatani nusxalash
        </button>
      </div>
    </div>
  {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-8 text-center">
      <svg class="w-12 h-12 mx-auto text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M12 2l4 4-4 4-4-4 4-4zm0 8v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <p class="mt-3 text-gray-600 dark:text-gray-300">
        Bu mijoz uchun koordinata kiritilmagan.
      </p>
      <a href="#" class="inline-block mt-4 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        Koordinata qo‘shish
      </a>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
{% if client.latitude and client.longitude %}
<script>
  const LAT = {{ client.latitude|default:"null" }};
  const LON = {{ client.longitude|default:"null" }};
  const addrText = document.getElementById("addr-text");
  const yandexLink = document.getElementById("yandex-link");
  const copyBtn = document.getElementById("copy-coord");

  ymaps.ready(init);
  function init(){
    const map = new ymaps.Map("map", {
      center: [LAT, LON],
      zoom: 16,
      controls: ["zoomControl"]
    });

    const placemark = new ymaps.Placemark([LAT, LON], {
      balloonContent: "{{ client.name|escapejs }}"
    }, {
      preset: "islands#blueDotIcon"
    });
    map.geoObjects.add(placemark);

    // Yandex link
    yandexLink.href = `https://yandex.com/maps/?ll=${LON},${LAT}&z=17&pt=${LON},${LAT},pm2rdm`;

    // Reverse geocode
    ymaps.geocode([LAT, LON]).then(res => {
      const firstGeoObject = res.geoObjects.get(0);
      addrText.textContent = firstGeoObject ? firstGeoObject.getAddressLine() : "Manzil topilmadi";
    }, () => {
      addrText.textContent = "Manzil topilmadi";
    });
  }

  // Copy coords
  copyBtn?.addEventListener("click", async ()=>{
    try {
      await navigator.clipboard.writeText(`${LAT.toFixed(6)}, ${LON.toFixed(6)}`);
      copyBtn.textContent = "Nusxa olindi!";
      setTimeout(()=> copyBtn.textContent = "Koordinatani nusxalash", 1200);
    } catch {
      alert("Nusxa olishni brauzeringiz chekladi.");
    }
  });
</script>
{% endif %}
{% endblock %}
