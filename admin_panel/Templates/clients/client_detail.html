{% extends "base.html" %}

{% block title %}{{ client.name }}{% endblock %}

{% block extra_head %}
  <!-- Leaflet CSS/JS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <style>
    #map { height: 360px; border-radius: 0.75rem; overflow: hidden; }
  </style>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-6">

  <!-- Header + actions -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ client.name }}</h1>
      <p class="text-sm text-gray-500 dark:text-gray-400">
        Yaratilgan: {{ client.created_at|date:"Y-m-d H:i" }} · Yangilangan: {{ client.updated_at|date:"Y-m-d H:i" }}
      </p>
    </div>
    <div class="flex items-center gap-2">
      <a href="{% url 'clients:list' %}" class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
        ← Ro‘yxatga qaytish
      </a>
      <a href="{% url 'clients:update' client.id %}" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        Tahrirlash
      </a>
      <a href="{% url 'clients:delete' client.id %}" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition">
        O‘chirish
      </a>
    </div>
  </div>

  <!-- Info card -->
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 space-y-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Ism</div>
        <div class="font-medium text-gray-900 dark:text-gray-100">{{ client.name }}</div>
      </div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Telefon</div>
        {% if client.phone_number %}
          <a href="tel:{{ client.phone_number }}" class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
            {{ client.phone_number }}
          </a>
        {% else %}
          <div class="text-gray-400">—</div>
        {% endif %}
      </div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Latitude</div>
        <div id="lat-text" class="font-mono text-gray-900 dark:text-gray-100">
          {% if client.latitude %}{{ client.latitude|floatformat:6 }}{% else %}—{% endif %}
        </div>
      </div>
      <div>
        <div class="text-sm text-gray-500 dark:text-gray-400">Longitude</div>
        <div id="lon-text" class="font-mono text-gray-900 dark:text-gray-100">
          {% if client.longitude %}{{ client.longitude|floatformat:6 }}{% else %}—{% endif %}
        </div>
      </div>
    </div>

    <!-- Address line (reverse geocode result) -->
    <div class="pt-2">
      <div class="text-sm text-gray-500 dark:text-gray-400">Manzil</div>
      <div id="addr-text" class="text-gray-900 dark:text-gray-100">
        {% if client.latitude and client.longitude %}
          Aniqlanmoqda…
        {% else %}
          Koordinata berilmagan
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Map or empty state -->
  {% if client.latitude and client.longitude %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
      <div id="map" class="bg-gray-200 dark:bg-gray-700"></div>
      <div class="mt-3 flex items-center gap-2">
        <a id="osm-link" href="#" target="_blank"
           class="px-3 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700 transition text-sm">
          OSM’da ko‘rish
        </a>
        <button id="copy-coord" type="button"
                class="px-3 py-2 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-600 transition text-sm">
          Koordinatani nusxalash
        </button>
      </div>
    </div>
  {% else %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-8 text-center">
      <svg class="w-12 h-12 mx-auto text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path d="M12 2l4 4-4 4-4-4 4-4zm0 8v12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <p class="mt-3 text-gray-600 dark:text-gray-300">
        Bu mijoz uchun koordinata kiritilmagan.
      </p>
      <a href="#" class="inline-block mt-4 px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        Koordinata qo‘shish
      </a>
    </div>
  {% endif %}

</div>
{% endblock %}

{% block extra_js %}
{% if client.latitude and client.longitude %}
<script>
  const LAT = {{ client.latitude|default:'null' }};
  const LON = {{ client.longitude|default:'null' }};
  const addrText = document.getElementById('addr-text');
  const osmLink = document.getElementById('osm-link');
  const copyBtn = document.getElementById('copy-coord');

  // Leaflet xarita
  const map = L.map('map').setView([LAT, LON], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  L.marker([LAT, LON]).addTo(map);

  // OSM link
  osmLink.href = `https://www.openstreetmap.org/?mlat=${LAT}&mlon=${LON}#map=17/${LAT}/${LON}`;

  // Reverse geocode (Nominatim)
  (async function() {
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${LAT}&lon=${LON}&zoom=18&addressdetails=1`;
      const resp = await fetch(url, { headers: {'Accept-Language': 'uz'} });
      const data = await resp.json();
      if (data && data.address) {
        const a = data.address;
        const street = a.road || '';
        const house  = a.house_number || '';
        const district = a.suburb || a.neighbourhood || a.city_district || '';
        const city = a.city || a.town || a.village || a.state || '';
        const full = [street, house, district, city].filter(Boolean).join(', ');
        addrText.textContent = full || (data.display_name || 'Manzil topilmadi');
      } else {
        addrText.textContent = 'Manzil topilmadi';
      }
    } catch (e) {
      addrText.textContent = 'Manzil topilmadi';
    }
  })();

  // Copy to clipboard
  copyBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(`${LAT.toFixed(6)}, ${LON.toFixed(6)}`);
      copyBtn.textContent = 'Nusxa olindi!';
      setTimeout(()=> copyBtn.textContent = 'Koordinatani nusxalash', 1200);
    } catch {
      alert('Nusxa olishni brauzeringiz chekladi.');
    }
  });
</script>
{% endif %}
{% endblock %}
