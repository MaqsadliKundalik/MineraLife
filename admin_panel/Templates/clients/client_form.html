{% extends "base.html" %}

{% block title %}{% if client %}Mijozni tahrirlash{% else %}Yangi mijoz qo‘shish{% endif %}{% endblock %}

{% block extra_head %}
  <!-- Yandex Maps API -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=uz_UZ" type="text/javascript"></script>
  <style>
    #map { height: 360px; border-radius: 0.75rem; overflow: hidden; }
  </style>
{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
  <div class="mb-6 flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        {% if client %}Mijozni tahrirlash{% else %}Yangi mijoz{% endif %}
      </h1>
      <p class="text-gray-600 dark:text-gray-400 mt-1">
        {% if client %}Mijoz ma’lumotlarini o‘zgartiring{% else %}Mijoz ma’lumotlarini kiriting{% endif %}
      </p>
    </div>
    <a href="{% url 'clients:list' %}"
       class="px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
      ← Ro‘yxatga qaytish
    </a>
  </div>

  <form method="post" enctype="multipart/form-data" class="bg-white dark:bg-gray-800 rounded-xl shadow p-6 space-y-5">
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="px-4 py-3 rounded-lg bg-red-100 text-red-800">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div>
      <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Ism <span class="text-red-500">*</span></label>
      {{ form.name }}
      {% if form.name.errors %}<p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>{% endif %}
    </div>

    <div>
      <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Telefon</label>
      {{ form.phone_number }}
      <p class="mt-1 text-xs text-gray-500">Masalan: +998 90 123 45 67</p>
      {% if form.phone_number.errors %}<p class="mt-1 text-sm text-red-600">{{ form.phone_number.errors.0 }}</p>{% endif %}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Latitude</label>
        {{ form.latitude }}
        {% if form.latitude.errors %}<p class="mt-1 text-sm text-red-600">{{ form.latitude.errors.0 }}</p>{% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-200">Longitude</label>
        {{ form.longitude }}
        {% if form.longitude.errors %}<p class="mt-1 text-sm text-red-600">{{ form.longitude.errors.0 }}</p>{% endif %}
      </div>
    </div>

    <!-- Interaktiv xarita + qidiruv -->
    <div class="mt-4 space-y-3">
      <div class="flex items-center gap-2">
        <input id="address-input" type="text" placeholder="Manzil qidirish (masalan: Chilonzor, Toshkent)"
               class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800
                      text-gray-800 dark:text-gray-100 px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500">
        <button id="address-search" type="button"
                class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
          Qidirish
        </button>
      </div>

      <div id="map" class="bg-gray-200 dark:bg-gray-700"></div>

      <p class="text-xs text-gray-500 dark:text-gray-400">
        Xaritada nuqtani bosing yoki markerni sudrab qo‘ying — koordinatalar avtomatik to‘ldiriladi.
      </p>

      <p id="selected-address" class="mt-2 text-sm text-gray-700 dark:text-gray-300">
        Tanlangan manzil: <span class="italic text-gray-500">hali tanlanmagan</span>
      </p>
    </div>

    <div class="flex items-center gap-3 pt-2">
      <button type="submit" class="px-5 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        {% if client %}Saqlash{% else %}Saqlash{% endif %}
      </button>
      <a href="{% url 'clients:list' %}"
         class="px-5 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
        Bekor qilish
      </a>
    </div>
  </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // DOM
  const latInput = document.getElementById("id_latitude");
  const lonInput = document.getElementById("id_longitude");
  const addressInput = document.getElementById("address-input");
  const searchBtn = document.getElementById("address-search");
  const addressLine = document.getElementById("selected-address");

  const TASHKENT_CENTER = [41.311081, 69.240562];

  let map, placemark;

  // --- Yordamchi: Yandex + OSM fallback bilan reverse geocode
  async function reverseAddress(lat, lon){
    // 1) Yandex (aniqroq joy topishi uchun kind: 'house')
    try {
      const res = await ymaps.geocode([lat, lon], { results: 1, kind: 'house' });
      const obj = res.geoObjects.get(0);
      if (obj) {
        return obj.getAddressLine();
      }
    } catch (e) { /* yandex muvaffaqiyatsiz bo‘lsa -> fallback */ }

    // 2) OSM Nominatim fallback
    try {
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
      const resp = await fetch(url, { headers: { 'Accept-Language': 'uz' } });
      if (resp.ok) {
        const data = await resp.json();
        if (data && (data.display_name || (data.address && (data.address.road || data.address.city)))) {
          const a = data.address || {};
          const street = a.road || '';
          const house  = a.house_number || '';
          const district = a.suburb || a.neighbourhood || a.city_district || '';
          const city = a.city || a.town || a.village || a.state || '';
          const full = [street, house, district, city].filter(Boolean).join(', ');
          return full || data.display_name;
        }
      }
    } catch (e) { /* ikkinchi urinish ham bo‘lmadi */ }

    return "Aniqlanmadi";
  }

  function placeMarker(lat, lon){
    const coords = [lat, lon];
    if (!placemark) {
      placemark = new ymaps.Placemark(coords, {}, { draggable: true, preset: "islands#blueIcon" });
      placemark.events.add('dragend', async () => {
        const c = placemark.geometry.getCoordinates();
        await setLatLon(c[0], c[1], false);
      });
      map.geoObjects.add(placemark);
    } else {
      placemark.geometry.setCoordinates(coords);
    }
    map.setCenter(coords, 15, { duration: 200 });
  }

  async function setLatLon(lat, lon, moveMarker = true){
    const fLat = parseFloat(lat), fLon = parseFloat(lon);
    if (!isFinite(fLat) || !isFinite(fLon)) return;

    latInput.value = fLat.toFixed(6);
    lonInput.value = fLon.toFixed(6);

    if (moveMarker) placeMarker(fLat, fLon);

    // Reverse geocode (Yandex -> OSM fallback)
    addressLine.innerHTML = 'Tanlangan manzil: <span class="italic text-gray-500">Aniqlanmoqda...</span>';
    const addr = await reverseAddress(fLat, fLon);
    addressLine.textContent = `Tanlangan manzil: ${addr}`;
  }

  // Init Yandex map
  ymaps.ready(()=>{
    map = new ymaps.Map('map', {
      center: TASHKENT_CENTER,
      zoom: 12,
      controls: ['zoomControl', 'fullscreenControl']
    });

    // Oldindan qiymatlar bo‘lsa — marker qo‘yish
    if (latInput.value && lonInput.value) {
      setLatLon(latInput.value, lonInput.value, true);
    } else if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => setLatLon(pos.coords.latitude, pos.coords.longitude, true),
        ()=>{}, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }

    // Xarita click -> marker + lat/lon + reverse
    map.events.add('click', e=>{
      const coords = e.get('coords'); // [lat, lon]
      setLatLon(coords[0], coords[1], true);
    });
  });

  // Qidiruv (Yandex geocode) – matndan koordinataga
  function geocodeAddress(q){
    if (!q) return;
    ymaps.geocode(q, { results: 1, boundedBy: [[41.0, 68.5],[41.6, 69.6]], strictBounds: false })
      .then(res=>{
        const obj = res.geoObjects.get(0);
        if (!obj) { alert("Manzil topilmadi."); return; }
        const coords = obj.geometry.getCoordinates(); // [lat, lon]
        setLatLon(coords[0], coords[1], true);
      })
      .catch(()=> alert("Qidirishda xatolik yuz berdi."));
  }

  searchBtn?.addEventListener('click', ()=> geocodeAddress(addressInput.value));
  addressInput?.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') {
      e.preventDefault();
      geocodeAddress(addressInput.value);
    }
  });
</script>
{% endblock %}
