{% extends "base.html" %}
{% block title %}Kuryer xaritasi{% endblock %}

{% block extra_head %}
  <!-- Yandex Maps API -->
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
  <style>
    #courier-map { height: calc(100vh - 140px); border-radius: .75rem; overflow: hidden; }

    /* Ustki harakat tugmalari (Recenter, Fullscreen) */
    .ml-actions{ position:absolute; right:.75rem; top:.75rem; display:flex; flex-direction:column; gap:.4rem; z-index:30; }
    .ml-action-btn{ padding:.35rem .6rem; border-radius:.5rem; background: rgba(255,255,255,.9);
      box-shadow: 0 10px 30px rgba(0,0,0,.2); font-size: 12px; }
    .dark .ml-action-btn{ background: rgba(17,24,39,.88); color:#E5E7EB; }

    /* Modal doimo xarita ustida */
    #order-modal { position: fixed; inset: 0; z-index: 10050; }
    #order-modal .modal-backdrop { position: absolute; inset: 0; z-index: 10040; background: rgba(0,0,0,.5); }
    #order-modal .modal-card { position: relative; z-index: 10060; }
  </style>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto mb-3">
  <div class="grid grid-cols-3 gap-4"> <!-- üîπ 2 emas, 3 ustun -->
        <div class="bg-green-100 dark:bg-green-800 p-4 rounded-lg text-center shadow">
            <p class="text-sm text-gray-600 dark:text-gray-300">Naqd tushum</p>
            <p class="text-2xl font-bold text-green-700 dark:text-green-300">{{ stats.cash|floatformat:0 }} so‚Äòm</p>
        </div>
        <div class="bg-blue-100 dark:bg-blue-800 p-4 rounded-lg text-center shadow">
            <p class="text-sm text-gray-600 dark:text-gray-300">Karta tushum</p>
            <p class="text-2xl font-bold text-blue-700 dark:text-blue-300">{{ stats.card|floatformat:0 }} so‚Äòm</p>
        </div>
        <div class="bg-purple-100 dark:bg-purple-800 p-4 rounded-lg text-center shadow">
            <p class="text-sm text-gray-600 dark:text-gray-300">Perechesleniya tushum</p>
            <p class="text-2xl font-bold text-purple-700 dark:text-purple-300">{{ stats.perechesleniya|floatformat:0 }} so‚Äòm</p>
        </div>
    </div>
</div>

<div class="flex items-center justify-between mb-3">
  <a href="{% url 'couriers:dashboard' %}"
     class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 
            text-gray-800 dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
    ‚Üê Orqaga
  </a>
  <h1 class="text-lg font-semibold text-gray-800 dark:text-gray-100">Buyurtmalar xaritasi</h1>
</div>

<div class="relative">
  <div id="courier-map" class="bg-gray-200 dark:bg-gray-700"></div>

  <!-- Actions (o‚Äòng-ust) -->
  <div class="ml-actions">
    <button id="ml-fit" class="ml-action-btn">Recenter</button>
    <button id="ml-fs"  class="ml-action-btn">Fullscreen</button>
  </div>
</div>

<!-- MODAL -->
<div id="order-modal" class="fixed inset-0 hidden">
  <div class="absolute inset-0 modal-backdrop" onclick="closeOrderModal()"></div>

  <div class="modal-card relative mx-auto mt-10 w-[95vw] max-w-xl bg-white dark:bg-gray-800 rounded-xl shadow-lg">
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Buyurtma tafsilotlari</h3>
      <button class="text-gray-500 hover:text-gray-700 dark:text-gray-300" onclick="closeOrderModal()">‚úï</button>
    </div>

    <div class="px-5 py-4 space-y-3 text-sm">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <div class="text-gray-500 dark:text-gray-400">Mijoz</div>
          <div id="modal-client" class="font-medium text-gray-900 dark:text-gray-100">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500 dark:text-gray-400">Telefon</div>
          <div id="modal-phone" class="font-medium text-gray-900 dark:text-gray-100">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500 dark:text-gray-400">Sana</div>
          <div id="modal-date" class="font-medium text-gray-900 dark:text-gray-100">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500 dark:text-gray-400">Miqdor / Narx</div>
          <div id="modal-amount" class="font-medium text-gray-900 dark:text-gray-100">‚Äî</div>
        </div>
        <div>
          <div class="text-gray-500 dark:text-gray-400">To‚Äòlov</div>
          <div id="modal-payment" class="font-medium text-gray-900 dark:text-gray-100">‚Äî</div>
        </div>
        <div class="sm:col-span-2">
          <div class="text-gray-500 dark:text-gray-400">Manzil</div>
          <div id="modal-address" class="font-medium text-gray-900 dark:text-gray-100">Yuklanmoqda‚Ä¶</div>
        </div>
      </div>

      <!-- Dashboard uslubidagi tugmalar -->
      <div class="pt-2 flex justify-end gap-2">
        <button type="button"
                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                onclick="submitStatus('completed')">
          ‚úÖ Bajardim
        </button>
        <button type="button"
                class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                onclick="submitStatus('cancelled')">
          ‚ùå Bekor qildim
        </button>
      </div>

      <p id="modal-error" class="hidden text-red-600 text-sm mt-2"></p>
      <input type="hidden" id="modal-order-id" value="">
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // --- Ma'lumotlar ---
  const points = {{ points|safe }};
  const center = [41.311081, 69.240562]; // Toshkent

  // Status -> preset (rang + label ko‚Äòrinadigan marker)
  function presetForStatus(p){
    const raw = (p.status_raw || p.status || '').toLowerCase();
    if (raw.includes('completed') || raw.includes('bajardi')) return 'islands#greenStretchyIcon';
    if (raw.includes('cancelled') || raw.includes('bekor'))  return 'islands#redStretchyIcon';
    return 'islands#blueStretchyIcon'; // pending/default
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // --- Yandex xarita ---
  ymaps.ready(init);
  let map, collection;

  function init(){
    map = new ymaps.Map("courier-map", {
      center: center, zoom: 11, controls: ["zoomControl", "fullscreenControl"]
    });

    collection = new ymaps.GeoObjectCollection();

    // Markerlar
    points.forEach(p => {
      const placemark = new ymaps.Placemark([p.lat, p.lon], {
        iconContent: esc(p.client),  // Mijoz nomi markerning o‚Äòzida ko‚Äòrinadi
        balloonContent: `
          <strong>Mijoz:</strong> ${esc(p.client)}<br>
          ${p.phone ? `<strong>Tel:</strong> ${esc(p.phone)}<br>` : ''}
          <strong>Status:</strong> ${esc(p.status)}<br>
          <strong>Sana:</strong> ${esc(p.date)}<br>
          <strong>Miqdor/Narx:</strong> ${p.quantity} ¬∑ ${Number(p.price).toLocaleString()} so'm<br>
          <strong>To‚Äòlov:</strong> ${esc(p.payment)}
          <div style="margin-top:.5rem">
            <button onclick="openOrderModal(${p.id})" class="px-2 py-1 rounded bg-indigo-600 text-white">Holatini o'zgartirish</button>
          </div>
        `
      }, {
        preset: presetForStatus(p),
        iconMaxWidth: 240
      });

      collection.add(placemark);
    });

    map.geoObjects.add(collection);
    recenter();

    // Recenter tugmasi
    document.getElementById('ml-fit').addEventListener('click', recenter);

    // Fullscreen tugmasi
    const fsBtn = document.getElementById('ml-fs');
    const mapEl = document.getElementById('courier-map');
    fsBtn.addEventListener('click', async ()=>{
      if(!document.fullscreenElement){
        await mapEl.requestFullscreen?.();
        fsBtn.textContent = 'Exit fullscreen';
      } else {
        await document.exitFullscreen?.();
        fsBtn.textContent = 'Fullscreen';
      }
      setTimeout(()=> map.container.fitToViewport(), 200);
    });
    document.addEventListener('fullscreenchange', ()=> setTimeout(()=> map.container.fitToViewport(), 150));
  }

  function recenter(){
    const bounds = map.geoObjects.getBounds();
    if(bounds) map.setBounds(bounds, {checkZoomRange: true, zoomMargin: 20});
    else map.setCenter(center, 11);
  }

  // --- Modal mantiqi ---
  const modal = document.getElementById('order-modal');
  const modalId = document.getElementById('modal-order-id');
  const elClient = document.getElementById('modal-client');
  const elPhone  = document.getElementById('modal-phone');
  const elDate   = document.getElementById('modal-date');
  const elAmount = document.getElementById('modal-amount');
  const elPay    = document.getElementById('modal-payment');
  const elAddr   = document.getElementById('modal-address');
  const elErr    = document.getElementById('modal-error');

  function openOrderModal(id){
    const p = points.find(x => x.id === id);
    if(!p) return;

    modalId.value = id;
    elClient.textContent = p.client;
    elPhone.textContent  = p.phone || '‚Äî';
    elDate.textContent   = p.date;
    elAmount.textContent = `${p.quantity} dona ¬∑ ${Number(p.price).toLocaleString()} so'm`;
    elPay.textContent    = p.payment;

    // Reverse geocoding (Nominatim ‚Äî API keysiz, frontdan)
    elAddr.textContent = 'Yuklanmoqda‚Ä¶';
    reverseGeocode(p.lat, p.lon).then(addr=>{
      elAddr.textContent = addr || `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}`;
    }).catch(()=>{
      elAddr.textContent = `${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}`;
    });

    modal.classList.remove('hidden');
  }

  function closeOrderModal(){
    elErr.classList.add('hidden');
    modal.classList.add('hidden');
  }

  window.openOrderModal = openOrderModal;
  window.closeOrderModal = closeOrderModal;

  // --- Reverse geocoding (OSM Nominatim) ---
  async function reverseGeocode(lat, lon){
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}&accept-language=uz`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('geocode-failed');
    const data = await res.json();
    return data.display_name || '';
  }

  // --- CSRF helper ---
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
  }
  const csrftoken = getCookie('csrftoken');

  // --- Status yuborish (dashboard uslubida) ---
  async function submitStatus(newStatus){
    const id = modalId.value;
    if(!id) return;

    const updateUrl = "{% url 'couriers:order_update' 0 %}".replace('0', id);
    try{
      const resp = await fetch(updateUrl, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Accept': 'text/html' },
        body: new URLSearchParams({ status: newStatus })
      });
      if(!resp.ok) throw new Error('update-failed');
      location.reload(); // tezkor yo‚Äòl: ranglar/statistika yangilanadi
    }catch(err){
      elErr.textContent = "Xatolik yuz berdi. Qayta urinib ko‚Äòring.";
      elErr.classList.remove('hidden');
    }
  }
  window.submitStatus = submitStatus;
</script>
{% endblock %}
