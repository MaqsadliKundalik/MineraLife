{% extends "base.html" %}
{% load querystring %}
{% block title %}Buyurtmalar{% endblock %}

{% block extra_head %}
  {# Leaflet kerak emas endi #}
  <style>
    #orders-mini-map {
      height: 300px;
      border-radius: .75rem;
      overflow: hidden;
    }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block content %}

<!-- Sarlavha + Create -->
<div class="mb-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
  <div>
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Buyurtmalar</h1>
    <p class="text-gray-600 dark:text-gray-400 mt-1">Sana boâ€˜yicha filtrlash va mini xarita</p>
  </div>
  <a href="{% url 'orders:create' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">+ Buyurtma qoâ€˜shish</a>
</div>

<!-- Sana filtri -->

<form method="get" class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-4">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div>
      <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Boshlanish sanasi</label>
      <input type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}"
             class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800
                    text-gray-900 dark:text-gray-100 px-4 py-2 focus:ring-2 focus:ring-blue-500">
    </div>
    <div>
      <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Tugash sanasi</label>
      <input type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}"
             class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800
                    text-gray-900 dark:text-gray-100 px-4 py-2 focus:ring-2 focus:ring-blue-500">
    </div>

    <!-- Tez tanlov tugmalari -->
    <div class="flex items-end gap-2">
      <button type="submit"
              class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">
        Qoâ€˜llash
      </button>

      {# KECHA #}
      <a href="?{% query_transform preset='yesterday' start_date=None end_date=None page=None %}"
        aria-pressed="{% if preset == 'yesterday' %}true{% else %}false{% endif %}"
        class="px-3 py-2 rounded-lg text-sm transition
                {% if preset == 'yesterday' %}
                  bg-blue-600 text-white
                {% else %}
                  bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-600
                {% endif %}">
        Kecha
      </a>
      {# BUGUN #}
      <a href="?{% query_transform preset='today' start_date=None end_date=None page=None %}"
        aria-pressed="{% if preset == 'today' %}true{% else %}false{% endif %}"
        class="px-3 py-2 rounded-lg text-sm transition
                {% if preset == 'today' %}
                  bg-blue-600 text-white
                {% else %}
                  bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-600
                {% endif %}">
        Bugun
      </a>
      {# ERTAGA #}
      <a href="?{% query_transform preset='tomorrow' start_date=None end_date=None page=None %}"
        aria-pressed="{% if preset == 'tomorrow' %}true{% else %}false{% endif %}"
        class="px-3 py-2 rounded-lg text-sm transition
                {% if preset == 'tomorrow' %}
                  bg-blue-600 text-white
                {% else %}
                  bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-600
                {% endif %}">
        Ertaga
      </a>

      {# Tozalash (default bugun) #}
      <a href="?{% query_transform preset='today' start_date=None end_date=None page=None %}"
         class="ml-auto px-3 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition text-gray-800 dark:text-gray-100">
        Tozalash
      </a>
    </div>
  </div>

  {% if start_date and end_date %}
    <p class="mt-3 text-sm text-gray-500 dark:text-gray-400">
      Tanlangan oraliq: <strong>{{ start_date|date:"Y-m-d" }}</strong> â€” <strong>{{ end_date|date:"Y-m-d" }}</strong>
      {% if preset %} ({{ preset }}){% endif %}
    </p>
  {% endif %}
</form>

<!-- Mini xarita + "xaritada ko'rish" -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 mb-4">
  <div id="orders-mini-map" class="bg-gray-200 dark:bg-gray-700"></div>
  <div class="mt-3 text-right">
    <a href="{% url 'orders:map' %}?{% query_transform %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-100 hover:bg-gray-200 dark:hover:bg-gray-600 transition">
      ğŸ—ºï¸ Buyurtmalarni xaritada koâ€˜rish
    </a>
  </div>
</div>

{% if orders %}
  <!-- Ro'yxat kartalari -->
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
    {% for o in orders %}
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 flex flex-col justify-between">
      <div>
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-500 dark:text-gray-400">{{ o.effective_date|date:"Y-m-d" }}</div>
          <span class="px-2 py-1 rounded text-xs
                       {% if o.status == 'pending' %}bg-yellow-100 text-yellow-800
                       {% elif o.status == 'completed' %}bg-green-100 text-green-800
                       {% else %}bg-red-100 text-red-800{% endif %}">
            {{ o.get_status_display }}
          </span>
        </div>
        <h3 class="mt-2 text-lg font-semibold text-gray-900 dark:text-gray-100">{{ o.client.name }}</h3>
          <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
            Miqdor: <strong>{{ o.quantity }}</strong><br>
            Narx: <strong>{{ o.price }} so'm</strong><br>
            Kurer: <strong>{{ o.courier.username|default:"â€”" }}</strong><br>
            Toâ€˜lov: 
            <strong>
              {% if o.payment_method == 'card' %}ğŸ’³ Karta{% else %}ğŸ’µ Naqd{% endif %}
            </strong>
          </p>
        {% if o.notes %}<p class="mt-2 text-sm text-gray-500 line-clamp-2">{{ o.notes }}</p>{% endif %}
      </div>
      <div class="mt-3 flex gap-2 justify-end">
        <a href="{% url 'orders:detail' o.pk %}" class="px-3 py-2 rounded-md bg-white-100 dark:bg-gray-700 text-sm hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-100">Koâ€˜rish</a>
        <a href="{% url 'orders:update' o.pk %}" class="px-3 py-2 rounded-md bg-blue-600 text-white text-sm hover:bg-blue-700">Tahrirlash</a>
        <a href="{% url 'orders:delete' o.pk %}" class="px-3 py-2 rounded-md bg-red-600 text-white text-sm hover:bg-red-700">Oâ€˜chirish</a>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Pagination: filter paramlarini saqlab -->
  {% if page_obj %}
  <div class="mt-6 flex items-center justify-center gap-2">
    {% if page_obj.has_previous %}
      <a href="?{% query_transform page=page_obj.previous_page_number %}" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">Oldingi</a>
    {% else %}
      <span class="px-3 py-1 rounded-md bg-gray-100/60 dark:bg-gray-700/60 text-gray-400">Oldingi</span>
    {% endif %}
    <span class="px-3 py-1 text-sm text-gray-700 dark:text-gray-300">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?{% query_transform page=page_obj.next_page_number %}" class="px-3 py-1 rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">Keyingi</a>
    {% else %}
      <span class="px-3 py-1 rounded-md bg-gray-100/60 dark:bg-gray-700/60 text-gray-400">Keyingi</span>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <!-- Empty state -->
  <div class="flex flex-col items-center justify-center py-16">
    <svg class="w-20 h-20 text-gray-400 dark:text-gray-600 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path d="M9 17v-2h6v2m-7 4h8a2 2 0 002-2v-9a2 2 0 00-2-2h-3l-1-2H9l-1 2H5a2 2 0 00-2 2v9a2 2 0 002 2z"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Tanlangan oraliqda buyurtmalar yoâ€˜q</h2>
    <p class="text-gray-500 dark:text-gray-400 mt-2 text-center max-w-md">
      Sana oraligâ€˜ini oâ€˜zgartirib koâ€˜ring yoki yangi buyurtma qoâ€˜shing.
    </p>
    <a href="{% url 'orders:create' %}" class="mt-6 px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">+ Buyurtma qoâ€˜shish</a>
  </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
  const points = {{ map_points|safe }};
  const center = [41.311081, 69.240562]; // Toshkent

  // Status -> preset xaritasi (StretchyIcon: rang + matnli marker)
  function presetForStatus(p){
    const raw = (p.status_raw || p.status || '').toLowerCase();
    if (raw.includes('completed') || raw.includes('bajardi')) return 'islands#greenStretchyIcon';
    if (raw.includes('cancelled') || raw.includes('bekor'))  return 'islands#redStretchyIcon';
    return 'islands#blueStretchyIcon'; // pending/default
  }

  // Xavfsiz matn
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  ymaps.ready(init);
  function init() {
    const map = new ymaps.Map("orders-mini-map", {
      center, zoom: 12, controls: ["zoomControl", "fullscreenControl"]
    });

    const cluster = new ymaps.GeoObjectCollection(); // koâ€˜p marker boâ€˜lsa ham yengil boshqariladi

    points.forEach(p => {
      const preset = presetForStatus(p);

      const placemark = new ymaps.Placemark([p.lat, p.lon], {
        // ğŸ”¹ Mijoz nomi markerning oâ€˜zida koâ€˜rinadi:
        iconContent: esc(p.client),
        // ğŸ”¹ Balloon toâ€˜liq tafsilot:
        balloonContent: `
          <strong>Mijoz:</strong> ${esc(p.client)}<br>
          <strong>Status:</strong> ${esc(p.status)}<br>
          <strong>Sana:</strong> ${esc(p.date)}<br>
          <strong>Narx:</strong> ${Number(p.price).toLocaleString()} so'm<br>
          ${p.payment ? `<strong>Toâ€˜lov:</strong> ${esc(p.payment)}` : ''}
        `
      }, {
        preset,                 // islands#...StretchyIcon â€” rang va label
        iconMaxWidth: 220       // uzun nomlar sigâ€˜ishi uchun
      });

      cluster.add(placemark);
    });

    map.geoObjects.add(cluster);

    // Markerlar boâ€˜yicha avtomatik koâ€˜rinish
    const bounds = map.geoObjects.getBounds();
    if (bounds) map.setBounds(bounds, { checkZoomRange: true, zoomMargin: 20 });
  }
</script>
{% endblock %}
