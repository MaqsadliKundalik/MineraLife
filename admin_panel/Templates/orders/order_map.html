{% extends "base.html" %}
{% block title %}Buyurtmalar xaritasi{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<style>
  /* Navbar balandligiga qarab moslang */
  #orders-full-map{
    height: calc(100vh - 140px);
    border-radius: .75rem;
    overflow: hidden;
  }
  /* Control panel ko‘rinishi */
  .ml-control{
    font-size: 12px;
    line-height: 1.2;
    border-radius: .75rem;
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    backdrop-filter: blur(6px);
  }
  .ml-control.light{
    background: rgba(255,255,255,.9);
    color:#111827;
  }
  .dark .ml-control.light{
    background: rgba(17,24,39,.88);
    color:#E5E7EB;
  }
  .ml-control .row{ display:grid; grid-template-columns:1fr 1fr; gap:.5rem }
  .ml-input, .ml-select, .ml-btn{
    border:1px solid rgba(107,114,128,.5);
    background: transparent;
    color: inherit;
    border-radius:.5rem;
    padding:.4rem .6rem;
    width:100%;
  }
  .ml-btn.primary{ background:#2563eb; color:#fff; border-color:#2563eb }
  .ml-chip{ padding:.25rem .5rem; border-radius:.5rem; border:1px solid rgba(107,114,128,.5); cursor:pointer; }
  .ml-chip.active{ background:#2563eb; color:#fff; border-color:#2563eb }
  /* Top-right action control tugmalari */
  .ml-actions{ display:flex; flex-direction:column; gap:.4rem }
  .ml-action-btn{ padding:.35rem .6rem; border-radius:.5rem; background: rgba(255,255,255,.9); }
  .dark .ml-action-btn{ background: rgba(17,24,39,.88); color:#E5E7EB; }
  /* Katta panellarni mobil ekranlarda bir oz siqamiz */
  @media (max-width: 768px){
    .ml-control{ max-width: 92vw }
    .ml-control .row{ grid-template-columns:1fr }
  }
</style>
{% endblock %}

{% block content %}
<div>
  <div id="orders-full-map" class="bg-gray-200 dark:bg-gray-700"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Serverdan kelgan ma'lumotlar
  const points = {{ points|safe }};
  const initialStart = "{{ start_date|date:'Y-m-d' }}";
  const initialEnd   = "{{ end_date|date:'Y-m-d' }}";
  const preset       = "{{ preset|default:'' }}";
  const couriers     = {{ couriers|safe }};            // [{id, username}, ...]
  const selectedCouriers = {{ selected_couriers|safe }}; // [id, id, ...]

  // --- Leaflet xarita
  const center = [41.311081, 69.240562]; // Tashkent
  const map = L.map('orders-full-map', { zoomControl: true }).setView(center, 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  // --- Rangli marker ikonkalari (statusga ko‘ra)
  const iconBlue = L.icon({
    iconUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png",
    shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });
  const iconGreen = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
    shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });
  const iconRed = new L.Icon({
    iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
    shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png",
    iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowSize: [41,41]
  });

  function statusRawOrGuess(p) {
    // Backend p.status_raw yuborgan bo‘lsa — ishlatamiz
    if (p.status_raw) return p.status_raw;

    // Aks holda status matnidan taxmin qilamiz (uzbekcha)
    const s = (p.status || '').toLowerCase();
    if (s.includes('bajardi')) return 'completed';
    if (s.includes('bekor')) return 'cancelled';
    // default
    return 'pending';
  }

  const markers = [];
  points.forEach(p => {
    const raw = statusRawOrGuess(p);
    let icon = iconBlue;                      // pending default
    if (raw === 'completed') icon = iconGreen;
    if (raw === 'cancelled') icon = iconRed;

    const m = L.marker([p.lat, p.lon], {icon}).addTo(map);
    const html = [
      `<strong>${escapeHtml(p.client)}</strong>`,
      p.courier ? `Kurer: ${escapeHtml(p.courier)}` : null,
      `${escapeHtml(p.status)} · ${escapeHtml(p.date)}`,
      `${Number(p.price).toLocaleString()} so'm`,
      `<a href="{% url 'orders:detail' 0 %}".replace('0', p.id) class="underline text-blue-600">Ko‘rish</a>`
    ].filter(Boolean).join('<br>');
    m.bindPopup(html);
    markers.push(m);
  });

  function fitAll(){
    if(markers.length){
      const g = L.featureGroup(markers);
      map.fitBounds(g.getBounds().pad(0.15));
    }else{
      map.setView(center, 11);
    }
  }
  fitAll();

  // === 1) FILTER CONTROL (chap-ust) — Leaflet control sifatida ===
  const FilterControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd: function(){
      const div = L.DomUtil.create('div', 'leaflet-control ml-control light');
      div.style.padding = '12px';
      div.innerHTML = `
        <div style="font-weight:600; margin-bottom:.4rem">Filtrlar</div>
        <form id="ml-filter-form" method="get" class="space-y-2">
          <div class="row">
            <div>
              <label style="font-size:.75rem">Boshlanish</label>
              <input class="ml-input" type="date" name="start_date" value="${initialStart || ''}">
            </div>
            <div>
              <label style="font-size:.75rem">Tugash</label>
              <input class="ml-input" type="date" name="end_date" value="${initialEnd || ''}">
            </div>
          </div>

          <div style="display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.2rem">
            <button type="button" data-preset="yesterday" class="ml-chip ${preset==='yesterday'?'active':''}">Kecha</button>
            <button type="button" data-preset="today"     class="ml-chip ${preset==='today'?'active':''}">Bugun</button>
            <button type="button" data-preset="tomorrow"  class="ml-chip ${preset==='tomorrow'?'active':''}">Ertaga</button>
          </div>

          <div>
            <label style="font-size:.75rem">Kurer(lar)</label>
            <select class="ml-select" name="courier" multiple>
              ${couriers.map(c => `<option value="${c.id}" ${selectedCouriers.includes(c.id)?'selected':''}>${c.username}</option>`).join('')}
            </select>
            <div style="font-size:.7rem; opacity:.8; margin-top:.25rem">Bir nechta tanlash uchun Ctrl/Cmd</div>
          </div>

          <div style="display:flex; gap:.5rem; margin-top:.3rem">
            <button class="ml-btn primary" type="submit">Qo‘llash</button>
            <button class="ml-btn" type="button" id="ml-clear">Tozalash</button>
          </div>
        </form>
      `;

      // Map pan/zoomni bloklamaslik uchun:
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);

      // Preset tugmalar: start/end'ni tozalab, preset bilan submit
      div.querySelectorAll('[data-preset]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const f = div.querySelector('#ml-filter-form');
          // start/end tozalash
          f.querySelector('[name=start_date]').value = '';
          f.querySelector('[name=end_date]').value = '';
          // URL yasab yuboramiz (GET)
          const url = new URL(location.href);
          url.searchParams.set('preset', btn.dataset.preset);
          url.searchParams.delete('start_date');
          url.searchParams.delete('end_date');
          url.searchParams.delete('page');
          // courier multiple tanlovlarini ham olib o‘tamiz
          const selected = Array.from(f.querySelector('[name=courier]').selectedOptions).map(o=>o.value);
          url.searchParams.delete('courier');
          selected.forEach(id => url.searchParams.append('courier', id));
          location.href = url.toString();
        });
      });

      // Tozalash: bugun
      div.querySelector('#ml-clear').addEventListener('click', ()=>{
        const url = new URL(location.href);
        url.searchParams.set('preset','today');
        url.searchParams.delete('start_date');
        url.searchParams.delete('end_date');
        url.searchParams.delete('page');
        url.searchParams.delete('courier');
        location.href = url.toString();
      });

      // Oddiy submit (qo‘lda sanalar)
      div.querySelector('#ml-filter-form').addEventListener('submit', (e)=>{
        // presetni olib tashlaymiz, sanalar ishlasin
        const url = new URL(location.href);
        url.searchParams.delete('preset');
        url.searchParams.delete('page');
        const f = e.target;
        const s = f.start_date.value;
        const en = f.end_date.value;
        if(s) url.searchParams.set('start_date', s); else url.searchParams.delete('start_date');
        if(en) url.searchParams.set('end_date', en); else url.searchParams.delete('end_date');
        // courier multiple
        url.searchParams.delete('courier');
        Array.from(f.courier.selectedOptions).forEach(o=>url.searchParams.append('courier', o.value));
        e.preventDefault();
        location.href = url.toString();
      });

      return div;
    }
  });
  map.addControl(new FilterControl({position:'topleft'}));

  // === 2) ACTIONS CONTROL (o‘ng-ust) ===
  const Actions = L.Control.extend({
    options:{ position:'topright' },
    onAdd:function(){
      const div = L.DomUtil.create('div','leaflet-control ml-actions');
      div.innerHTML = `
        <button id="ml-fit" class="ml-action-btn">Recenter</button>
        <button id="ml-fs"  class="ml-action-btn">Fullscreen</button>
      `;
      L.DomEvent.disableClickPropagation(div);
      L.DomEvent.disableScrollPropagation(div);
      return div;
    }
  });
  map.addControl(new Actions());

  // Recenter
  document.getElementById('ml-fit').addEventListener('click', fitAll);

  // Fullscreen
  const fsBtn = document.getElementById('ml-fs');
  const mapEl = document.getElementById('orders-full-map');
  fsBtn.addEventListener('click', async ()=>{
    if(!document.fullscreenElement){
      await mapEl.requestFullscreen?.();
      fsBtn.textContent = 'Exit fullscreen';
    }else{
      await document.exitFullscreen?.();
      fsBtn.textContent = 'Fullscreen';
    }
    setTimeout(()=>map.invalidateSize(), 200);
  });
  document.addEventListener('fullscreenchange', ()=> setTimeout(()=>map.invalidateSize(), 150));

  // Xavfsiz HTML uchun
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
{% endblock %}
