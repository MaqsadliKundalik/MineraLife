{% extends "base.html" %}
{% block title %}Buyurtmalar xaritasi{% endblock %}

{% block extra_head %}
  <!-- Yandex Maps API (API key required) -->
  {% if yandex_maps_api_key %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_maps_api_key }}&lang=ru_RU" type="text/javascript"></script>
  {% endif %}

  <style>
    /* Xarita balandligi (navbar + statistika panel'ni hisobga olib) */
    #orders-full-map{
      height: calc(100vh - 280px);
      border-radius: .75rem;
      overflow: hidden;
    }

    /* Floated panel umumiy ko‚Äòrinishi */
    .ml-control{
      font-size: 12px;
      line-height: 1.2;
      border-radius: .75rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      padding: 12px;
    }
    .ml-control.light{
      background: rgba(255,255,255,.9);
      color:#111827;
    }
    .dark .ml-control.light{
      background: rgba(17,24,39,.88);
      color:#E5E7EB;
    }
    .ml-control .row{ display:grid; grid-template-columns:1fr 1fr; gap:.5rem }
    .ml-input, .ml-select, .ml-btn{
      border:1px solid rgba(107,114,128,.5);
      background: transparent;
      color: inherit;
      border-radius:.5rem;
      padding:.4rem .6rem;
      width:100%;
    }
    .ml-btn.primary{ background:#2563eb; color:#fff; border-color:#2563eb }
    .ml-chip{ padding:.25rem .5rem; border-radius:.5rem; border:1px solid rgba(107,114,128,.5); cursor:pointer; }
    .ml-chip.active{ background:#2563eb; color:#fff; border-color:#2563eb }

  /* (Removed) actions panel styles */

    /* Panel ochib-yopish animatsiyasi */
    #filter-panel {
      transform-origin: top left;
      transition: transform .18s ease, opacity .18s ease;
    }
    #filter-panel.is-collapsed {
      opacity: 0;
      transform: scale(.96);
      pointer-events: none;
    }

    /* Filtr tugmasi (har doim ko‚Äòrinadi) */
    #filter-toggle {
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
    }

    /* Mobil: panel kengligini cheklash, gridni 1 ustun */
    @media (max-width: 768px){
      .ml-control{ max-width: 92vw }
      .ml-control .row{ grid-template-columns:1fr }
    }

    /* Kattaroq ekranlarda panel eni */
    @media (min-width: 769px){
      .ml-control{ max-width: 420px }
    }

    /* (Removed) Custom global search bar styles */
  </style>
{% endblock %}

{% block content %}
<div class="relative">
  <div id="orders-full-map" class="bg-gray-200 dark:bg-gray-700"></div>

  {% if not yandex_maps_api_key %}
  <div class="absolute inset-0 grid place-items-center p-6">
    <div class="max-w-md w-full rounded-xl bg-white/90 dark:bg-gray-800/90 shadow-xl border border-gray-200 dark:border-gray-700 p-5 text-center">
      <div class="text-lg font-semibold mb-2">Yandex Maps API kaliti kerak</div>
      <div class="text-sm opacity-80 mb-4">Xaritani ko‚Äòrsatish uchun Yandex Maps API kalitini sozlang. Sozlangandan so‚Äòng sahifani yangilang.</div>
      <div class="text-xs text-gray-500">ENV: YANDEX_MAPS_API_KEY</div>
    </div>
  </div>
  {% endif %}

  <!-- Kuryer biriktirish modal -->
  <div id="assignCourierModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Kuryer biriktirish
        </h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          Mijoz: <span id="modalClientName" class="font-medium"></span>
        </p>
      </div>
      
      <div class="px-6 py-4">
        <label for="courierSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Kuryerni tanlang
        </label>
        <select id="courierSelect" 
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500">
          <option value="">-- Kuryerni olib tashlash --</option>
        </select>
        
        <div id="assignError" class="hidden mt-3 p-2 bg-red-50 dark:bg-red-900 text-red-600 dark:text-red-200 text-sm rounded"></div>
      </div>
      
      <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex gap-3">
        <button type="button" 
                onclick="assignCourier()"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
          üíæ Saqlash
        </button>
        <button type="button" 
                onclick="closeAssignModal()"
                class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
          ‚ùå Bekor qilish
        </button>
      </div>
    </div>
  </div>

  <!-- üîò Filtrni ochib/yopish tugmasi (mobil + desktop) -->
  <button id="filter-toggle"
          class="absolute left-3 top-3 inline-flex items-center gap-2 px-3 py-2 rounded-full
                 bg-blue-600 text-white hover:bg-blue-700 active:bg-blue-800"
          aria-controls="filter-panel" aria-expanded="false" type="button">
    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h16M12 4v16"/>
    </svg>
    <span>Filtr</span>
  </button>

  <!-- üîΩ Filtr panel (default: yopiq) -->
  <div id="filter-panel" class="absolute left-3 top-14 ml-control light is-collapsed" role="dialog" aria-label="Filtrlar">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:.5rem; margin-bottom:.4rem">
      <div style="font-weight:600">Filtrlar</div>
      <!-- Yopish tugmasi -->
      <button type="button" id="filter-close" class="ml-chip" title="Yopish" style="line-height:1">‚úï</button>
    </div>

    <form id="ml-filter-form" method="get" class="space-y-2">
      <div class="row">
        <div>
          <label style="font-size:.75rem">Boshlanish</label>
          <input class="ml-input" type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}">
        </div>
        <div>
          <label style="font-size:.75rem">Tugash</label>
          <input class="ml-input" type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}">
        </div>
      </div>

      <div style="display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.2rem">
        <button type="button" data-preset="yesterday"
                class="ml-chip {% if preset == 'yesterday' %}active{% endif %}">Kecha</button>
        <button type="button" data-preset="today"
                class="ml-chip {% if preset == 'today' %}active{% endif %}">Bugun</button>
        <button type="button" data-preset="tomorrow"
                class="ml-chip {% if preset == 'tomorrow' %}active{% endif %}">Ertaga</button>
      </div>

      <div>
        <label style="font-size:.75rem">Kurer(lar)</label>
        <select class="ml-select" name="courier" multiple>
          {% for c in couriers %}
            <option value="{{ c.id }}" {% if c.id in selected_couriers %}selected{% endif %}>{{ c.username }}</option>
          {% endfor %}
        </select>
        <div style="font-size:.7rem; opacity:.8; margin-top:.25rem">Bir nechta tanlash uchun Ctrl/Cmd</div>
      </div>

      <div style="display:flex; gap:.5rem; margin-top:.3rem">
        <button class="ml-btn primary" type="submit">Qo‚Äòllash</button>
        <button class="ml-btn" type="button" id="ml-clear">Tozalash</button>
      </div>
    </form>
    <!-- Marshrut chizish bo'limi -->
    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(107,114,128,.3);">
      <div style="font-weight: 600; margin-bottom: 8px;">üìç Marshrut chizish</div>
      
      <!-- Kuryerlar ranglar legendasi -->
      <div id="courier-legend" style="margin-bottom: 8px; font-size: 10px; max-height: 100px; overflow-y: auto; padding: 4px; background: rgba(0,0,0,0.02); border-radius: 4px;">
        {% for c in couriers %}
          <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
            <div class="courier-color-box" data-courier-id="{{ c.id }}" style="width: 12px; height: 12px; border-radius: 2px; border: 1px solid rgba(0,0,0,0.2);"></div>
            <span style="font-size: 10px;">{{ c.username }}</span>
          </div>
        {% endfor %}
      </div>
      
      <select id="ml-route-courier" class="ml-select" style="margin-bottom: 8px;">
        <option value="">Kuryerni tanlang</option>
        {% for c in couriers %}
          <option value="{{ c.id }}">{{ c.username }}</option>
        {% endfor %}
      </select>
      <div style="display:flex; gap:.5rem;">
        <button type="button" id="ml-draw-route" class="ml-btn primary" disabled style="flex:1">
          ‚úèÔ∏è Marshrut chizish
        </button>
        <button type="button" id="ml-clear-route" class="ml-btn" style="background: #dc2626; color: white; border-color: #dc2626; flex:1" disabled>
          üóëÔ∏è O'chirish
        </button>
      </div>
      <div id="route-status" style="margin-top: 8px; font-size: 11px; color: #6b7280;"></div>
    </div>  </div>

  
</div>

<!-- Kuryer statistikasi paneli -->
<div class="mt-3 bg-white dark:bg-gray-800 rounded-lg shadow-sm p-4">
  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
    üìä Kuryer statistikasi
  </h3>
  <div id="courier-stats" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-3">
    <!-- JavaScript orqali to'ldiriladi -->
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // Early guard: if API key is missing, don't run map code
  const YM_API_KEY = '{{ yandex_maps_api_key|default:"" }}';
  if (!YM_API_KEY) {
    console.warn('Yandex Maps API key is missing. Map code skipped.');
    // Nothing else runs; overlay in HTML explains next steps
  } else {
  // === Serverdan kelgan ma'lumotlar ===
  const points = JSON.parse('{{ points|escapejs }}');
  const couriers = JSON.parse('{{ couriers_json|escapejs }}');
  const routes = JSON.parse('{{ routes|escapejs }}');
  const center = [41.311081, 69.240562]; // Toshkent

  // Har bir kuryer uchun unique rang generatsiya qilish
  function getCourierColor(courierId) {
    if (!courierId) return '#2563eb'; // default ko'k
    // ID asosida hue qiymatini hisoblash (0-360)
    const hue = (courierId * 137.508) % 360; // Golden angle
    // HSL ni HEX ga o'zgartirish (Yandex Maps uchun)
    return hslToHex(hue, 70, 50);
  }
  
  // HSL ni HEX formatga o'zgartirish
  function hslToHex(h, s, l) {
    s /= 100;
    l /= 100;
    const c = (1 - Math.abs(2 * l - 1)) * s;
    const x = c * (1 - Math.abs((h / 60) % 2 - 1));
    const m = l - c/2;
    let r = 0, g = 0, b = 0;
    if (0 <= h && h < 60) {
      r = c; g = x; b = 0;
    } else if (60 <= h && h < 120) {
      r = x; g = c; b = 0;
    } else if (120 <= h && h < 180) {
      r = 0; g = c; b = x;
    } else if (180 <= h && h < 240) {
      r = 0; g = x; b = c;
    } else if (240 <= h && h < 300) {
      r = x; g = 0; b = c;
    } else if (300 <= h && h < 360) {
      r = c; g = 0; b = x;
    }
    r = Math.round((r + m) * 255);
    g = Math.round((g + m) * 255);
    b = Math.round((b + m) * 255);
    return "#" + [r, g, b].map(x => {
      const hex = x.toString(16);
      return hex.length === 1 ? "0" + hex : hex;
    }).join('');
  }

  // Kuryerlar ranglarini legend'ga to'ldirish
  function initializeCourierLegend() {
    document.querySelectorAll('.courier-color-box').forEach(box => {
      const courierId = parseInt(box.dataset.courierId);
      box.style.backgroundColor = getCourierColor(courierId);
    });
  }

  // Kuryer statistikasini hisoblash va ko'rsatish
  function renderCourierStats() {
    const statsContainer = document.getElementById('courier-stats');
    if (!statsContainer) return;

    // Har bir kuryer uchun buyurtmalar sonini hisoblash
    const courierOrders = {};
    const courierNames = {};
    
    // Barcha kuryerlarni ro'yxatga olish
    couriers.forEach(c => {
      courierOrders[c.id] = 0;
      courierNames[c.id] = c.username;
    });
    
    // Kuryersiz buyurtmalar
    courierOrders['unassigned'] = 0;
    courierNames['unassigned'] = 'Tayinlanmagan';
    
    // Buyurtmalarni sanash
    points.forEach(p => {
      if (p.courier_id) {
        courierOrders[p.courier_id] = (courierOrders[p.courier_id] || 0) + 1;
      } else {
        courierOrders['unassigned']++;
      }
    });
    
    // HTML yaratish
    let html = '';
    
    // Tayinlanmagan buyurtmalarni birinchi ko'rsatish
    if (courierOrders['unassigned'] > 0) {
      html += `
        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 border-2 border-gray-300 dark:border-gray-600">
          <div class="flex items-center gap-2 mb-1">
            <div style="width: 16px; height: 16px; background: #1f2937; border-radius: 4px;"></div>
            <span class="text-sm font-medium text-gray-900 dark:text-white">Tayinlanmagan</span>
          </div>
          <div class="text-2xl font-bold text-gray-900 dark:text-white">${courierOrders['unassigned']}</div>
          <div class="text-xs text-gray-600 dark:text-gray-400">buyurtma</div>
        </div>
      `;
    }
    
    // Kuryerlar statistikasini ko'rsatish (faqat buyurtmasi borlar)
    Object.entries(courierOrders)
      .filter(([id, count]) => id !== 'unassigned' && count > 0)
      .sort((a, b) => b[1] - a[1]) // Ko'p buyurtmadan kamga
      .forEach(([courierId, count]) => {
        const color = getCourierColor(parseInt(courierId));
        const name = courierNames[courierId] || 'Noma\'lum';
        
        html += `
          <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 border-2 hover:shadow-lg transition-shadow cursor-pointer"
               style="border-color: ${color};"
               onclick="filterByCourier(${courierId})">
            <div class="flex items-center gap-2 mb-1">
              <div style="width: 16px; height: 16px; background: ${color}; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
              <span class="text-sm font-medium text-gray-900 dark:text-white">${esc(name)}</span>
            </div>
            <div class="text-2xl font-bold text-gray-900 dark:text-white">${count}</div>
            <div class="text-xs text-gray-600 dark:text-gray-400">buyurtma</div>
          </div>
        `;
      });
    
    statsContainer.innerHTML = html || '<div class="col-span-full text-center text-gray-500">Buyurtmalar yo\'q</div>';
  }
  
  // Kuryerga qarab filtr qilish
  function filterByCourier(courierId) {
    const form = document.getElementById('ml-filter-form');
    const select = form.querySelector('select[name="courier"]');
    if (select) {
      // Faqat shu kuryerni tanlash
      Array.from(select.options).forEach(opt => {
        opt.selected = (opt.value == courierId);
      });
      form.submit();
    }
  }

  // Status -> preset xaritasi (StretchyIcon: rang + label)
  function presetForStatus(p){
    // Kuryersiz buyurtmalar - TO'LIQ QORA
    if (!p.courier_id) {
      return 'islands#blackStretchyIcon';
    }
    
    const raw = (p.status_raw || p.status || '').toLowerCase();
    if (raw.includes('completed') || raw.includes('bajardi')) return 'islands#greenStretchyIcon';
    if (raw.includes('cancelled') || raw.includes('bekor'))  return 'islands#redStretchyIcon';
    return 'islands#blueStretchyIcon'; // pending/default
  }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&gt;','>':'&lt;','"':'&quot;',"'":'&#39;'}[m])); }

  let map;
  let allPlacemarks = []; // Barcha markerlarni saqlash
  let routeMode = false; // Marshrut chizish rejimi
  let currentRoute = null; // Hozirgi chizilayotgan marshrut
  let currentRouteCoords = []; // Chizilgan koordinatalar
  let selectedCourier = null; // Tanlangan kuryer
  let savedRoutes = {}; // Saqlangan marshrutlar (courier_id: polyline)

  ymaps.ready(init);
  function init(){
    map = new ymaps.Map("orders-full-map", {
      center: center, zoom: 11, controls: ["zoomControl", "fullscreenControl"]
    });

    // Kuryerlar ranglarini legend'ga to'ldirish
    initializeCourierLegend();
    
    // Kuryer statistikasini ko'rsatish
    renderCourierStats();

    renderMarkers();

    // Yandex SearchControl (joy nomlari bo'yicha qidiruv)
    const searchControl = new ymaps.control.SearchControl({
      options: {
        provider: 'yandex#search',
        useMapBounds: true,
        noPlacemark: false,
        size: 'large',
        float: 'right',
      }
    });
    map.controls.add(searchControl);

    // (Removed) custom Recenter and Fullscreen buttons

    // Preset chip‚Äôlari
    document.querySelectorAll('#filter-panel [data-preset]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const f = document.getElementById('ml-filter-form');
        f.start_date.value = '';
        f.end_date.value = '';
        const url = new URL(location.href);
        url.searchParams.set('preset', btn.dataset.preset);
        url.searchParams.delete('start_date');
        url.searchParams.delete('end_date');
        url.searchParams.delete('page');
        // courier multiple
        const selected = Array.from(f.courier.selectedOptions).map(o=>o.value);
        url.searchParams.delete('courier');
        selected.forEach(id => url.searchParams.append('courier', id));
        location.href = url.toString();
      });
    });

    // Tozalash (bugun)
    document.getElementById('ml-clear').addEventListener('click', ()=>{
      const url = new URL(location.href);
      url.searchParams.set('preset','today');
      url.searchParams.delete('start_date');
      url.searchParams.delete('end_date');
      url.searchParams.delete('page');
      url.searchParams.delete('courier');
      location.href = url.toString();
    });

    // Qo‚Äòlda sanalar submit
    document.getElementById('ml-filter-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const url = new URL(location.href);
      url.searchParams.delete('preset');
      url.searchParams.delete('page');
      const f = e.target;
      const s = f.start_date.value;
      const en = f.end_date.value;
      if(s) url.searchParams.set('start_date', s); else url.searchParams.delete('start_date');
      if(en) url.searchParams.set('end_date', en); else url.searchParams.delete('end_date');
      url.searchParams.delete('courier');
      Array.from(f.courier.selectedOptions).forEach(o=>url.searchParams.append('courier', o.value));
      location.href = url.toString();
    });

    // Filtr panel toggling (mobil + desktop, default yopiq)
    setupFilterToggle(map);
  }

  function renderMarkers(){
    map.geoObjects.removeAll();
    allPlacemarks = []; // Qidiruv uchun barcha markerlarni tozalash

    const placemarks = points.map(p => {
      const preset = presetForStatus(p);
      const placemark = new ymaps.Placemark([p.lat, p.lon], {
        iconContent: esc(p.client),
        balloonContent: `
          <div style="max-width: 280px;">
            <strong>üìã Mijoz:</strong> ${esc(p.client)}<br>
            ${p.courier ? `<strong>üë§ Kurer:</strong> ${esc(p.courier)}<br>` : '<strong style="color:#dc2626">‚ö†Ô∏è Kuryer biriktirilmagan</strong><br>'}
            <strong>üìä Status:</strong> ${esc(p.status)}<br>
            <strong>üìÖ Sana:</strong> ${esc(p.date)}<br>
            <strong>üí∞ Narx:</strong> ${Number(p.price).toLocaleString()} so'm<br>
            ${p.payment_method ? `<strong>üí≥ To'lov:</strong> ${esc(p.payment_method)}<br>` : ''}
            <strong>üì¶ Miqdor:</strong> Oldim ${p.inquantity}, Berdim ${p.outquantity}<br>
            <div style="margin-top: 8px; display: flex; gap: 8px;">
              <button onclick="openAssignModal(${p.id}, '${esc(p.client)}', ${p.courier_id || 'null'})" 
                      style="padding: 6px 12px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; flex: 1;">
                ${p.courier ? 'üîÑ Kuryerni o\'zgartirish' : '‚ûï Kuryer biriktirish'}
              </button>
              <a href="/orders/${p.id}/" 
                 style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; text-decoration: none; display: inline-block;">
                üëÅÔ∏è Ko'rish
              </a>
            </div>
          </div>
        `
      }, {
        preset,
        iconMaxWidth: 240
      });

      // Qidiruv uchun saqlash
      allPlacemarks.push({ placemark, point: p });
      
      return placemark;
    });

    // Markerlarni to'g'ridan-to'g'ri xaritaga qo'shish
    placemarks.forEach(pm => map.geoObjects.add(pm));
    
    // Saqlangan marshrutlarni chizish
    loadSavedRoutes();
    
    // Marshrut chizish funksiyasini sozlash
    setupRouteDrawing();
    
    recenter();
  }

  // Saqlangan marshrutlarni yuklash
  function loadSavedRoutes() {
    routes.forEach(route => {
      if (route.route_data && route.route_data.length > 0) {
        const polyline = new ymaps.Polyline(
          route.route_data,
          {
            hintContent: `Marshrut: ${route.courier_name || 'Noma\'lum'} (${route.date || ''})`
          },
          {
            strokeColor: route.color || '#2563eb',
            strokeWidth: 4,
            strokeOpacity: 0.7
          }
        );
        map.geoObjects.add(polyline);
        savedRoutes[route.courier_id] = polyline;
      }
    });
  }

  // Marshrut chizish sozlamalari
  function setupRouteDrawing() {
    const courierSelect = document.getElementById('ml-route-courier');
    const drawBtn = document.getElementById('ml-draw-route');
    const clearBtn = document.getElementById('ml-clear-route');
    const statusDiv = document.getElementById('route-status');

    // Kuryer tanlanganida tugmalarni aktivlashtirish
    courierSelect.addEventListener('change', function() {
      selectedCourier = this.value;
      drawBtn.disabled = !selectedCourier;
      clearBtn.disabled = !selectedCourier;
      
      // Barcha kuryer ranglarini reset qilish
      document.querySelectorAll('.courier-color-box').forEach(box => {
        box.style.borderWidth = '1px';
        box.style.boxShadow = 'none';
      });
      
      // Kuryer rangini ko'rsatish
      if (selectedCourier) {
        const color = getCourierColor(parseInt(selectedCourier));
        
        // Legenddagi rangni highlight qilish
        const legendBox = document.querySelector(`.courier-color-box[data-courier-id="${selectedCourier}"]`);
        if (legendBox) {
          legendBox.style.borderWidth = '2px';
          legendBox.style.boxShadow = '0 0 8px ' + color;
        }
        
        statusDiv.innerHTML = `<div style="display: flex; align-items: center; gap: 8px;">
          <div style="width: 24px; height: 24px; background: ${color}; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
          <span>Marshrut bu rangda chiziladi</span>
        </div>`;
        
        // Agar bu kuryer uchun marshrut mavjud bo'lsa
        if (savedRoutes[selectedCourier]) {
          statusDiv.innerHTML += '<div style="margin-top: 4px;">‚úÖ Bu kuryer uchun marshrut mavjud</div>';
        }
      } else {
        statusDiv.innerHTML = '';
      }
    });

    // Marshrut chizishni boshlash
    drawBtn.addEventListener('click', function() {
      if (routeMode) {
        // Chizishni tugatish va saqlash
        finishRoute();
      } else {
        // Chizishni boshlash
        startRouteDrawing();
      }
    });

    // Marshrutni o'chirish
    clearBtn.addEventListener('click', async function() {
      if (!selectedCourier) return;
      
      if (!confirm('Rostdan ham bu marshrutni o\'chirmoqchimisiz?')) return;
      
      try {
        const response = await fetch('/orders/route/delete/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            courier_id: selectedCourier,
            date: '{{ start_date|date:"Y-m-d" }}'
          })
        });
        
        const data = await response.json();
        if (data.success) {
          // Xaritadan o'chirish
          if (savedRoutes[selectedCourier]) {
            map.geoObjects.remove(savedRoutes[selectedCourier]);
            delete savedRoutes[selectedCourier];
          }
          statusDiv.innerHTML = '‚úÖ Marshrut o\'chirildi';
          setTimeout(() => statusDiv.innerHTML = '', 3000);
        } else {
          alert('Xatolik: ' + data.error);
        }
      } catch (error) {
        alert('Xatolik: ' + error.message);
      }
    });
  }

  // Marshrut chizishni boshlash
  function startRouteDrawing() {
    routeMode = true;
    currentRouteCoords = [];
    
    const drawBtn = document.getElementById('ml-draw-route');
    const statusDiv = document.getElementById('route-status');
    
    drawBtn.textContent = 'üíæ Marshrutni saqlash';
    drawBtn.style.background = '#16a34a';
    statusDiv.innerHTML = 'üñ±Ô∏è Xaritada nuqtalarni bosing';

    // Eski marshrutni o'chirish
    if (currentRoute) {
      map.geoObjects.remove(currentRoute);
    }
    if (savedRoutes[selectedCourier]) {
      map.geoObjects.remove(savedRoutes[selectedCourier]);
    }

    // Xaritaga click listener qo'shish
    map.events.add('click', onMapClick);
  }

  // Xaritaga bosilganida
  function onMapClick(e) {
    if (!routeMode) return;
    
    const coords = e.get('coords');
    currentRouteCoords.push(coords);
    
    // Chiziqni yangilash
    if (currentRoute) {
      map.geoObjects.remove(currentRoute);
      currentRoute = null;
    }
    
    // Kamida 2 nuqta bo'lganda chiziq chizish
    if (currentRouteCoords.length >= 2) {
      // Kuryerning rangini olish
      const courierColor = getCourierColor(parseInt(selectedCourier));
      
      currentRoute = new ymaps.Polyline(
        currentRouteCoords,
        {
          hintContent: `${currentRouteCoords.length} nuqta`
        },
        {
          strokeColor: courierColor,
          strokeWidth: 4,
          strokeOpacity: 0.7
        }
      );
      
      map.geoObjects.add(currentRoute);
    } else {
      // Birinchi nuqta - faqat marker
      const courierColor = getCourierColor(parseInt(selectedCourier));
      const placemark = new ymaps.Placemark(coords, {}, {
        preset: 'islands#dotIcon',
        iconColor: courierColor
      });
      map.geoObjects.add(placemark);
      setTimeout(() => map.geoObjects.remove(placemark), 30000);
    }
    
    const statusDiv = document.getElementById('route-status');
    statusDiv.innerHTML = `üìç ${currentRouteCoords.length} nuqta tanlandi`;
  }

  // Marshrutni tugatish va saqlash
  async function finishRoute() {
    if (currentRouteCoords.length < 2) {
      alert('Kamida 2 ta nuqta tanlang!');
      return;
    }
    
    routeMode = false;
    map.events.remove('click', onMapClick);
    
    const drawBtn = document.getElementById('ml-draw-route');
    const statusDiv = document.getElementById('route-status');
    
    drawBtn.disabled = true;
    statusDiv.innerHTML = '‚è≥ Saqlanmoqda...';
    
    try {
      const courierColor = getCourierColor(parseInt(selectedCourier));
      console.log('Saqlash:', {
        courier_id: selectedCourier,
        date: '{{ start_date|date:"Y-m-d" }}',
        route_data: currentRouteCoords,
        color: courierColor
      });
      
      const response = await fetch('/orders/route/save/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          courier_id: parseInt(selectedCourier),
          date: '{{ start_date|date:"Y-m-d" }}',
          route_data: currentRouteCoords,
          color: courierColor
        })
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error('Server xatosi:', errorText);
        throw new Error(`Server xatosi: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.success) {
        statusDiv.innerHTML = '‚úÖ Marshrut saqlandi';
        savedRoutes[selectedCourier] = currentRoute;
        currentRoute = null;
        
        // Tugmani qayta tiklash
        drawBtn.textContent = '‚úèÔ∏è Marshrut chizish';
        drawBtn.style.background = '#2563eb';
        drawBtn.disabled = false;
      } else {
        alert('Xatolik: ' + data.error);
        drawBtn.disabled = false;
      }
    } catch (error) {
      alert('Xatolik: ' + error.message);
      drawBtn.disabled = false;
    }
  }

  function recenter(){
    const bounds = map.geoObjects.getBounds();
    if(bounds) map.setBounds(bounds, {checkZoomRange: true, zoomMargin: 20});
    else map.setCenter(center, 11);
  }

  // (Removed) Custom search/highlight/filter functions ‚Äî using Yandex SearchControl instead

  // === Filtr panelini toggling (har doim tugma bilan, default: yopiq) ===
  function setupFilterToggle(mapInstance){
    const panel  = document.getElementById('filter-panel');
    const toggle = document.getElementById('filter-toggle');
    const close  = document.getElementById('filter-close');

    const storageKey = 'ml_map_filter_open';

    function apply(stateOpen){
      panel.classList.toggle('is-collapsed', !stateOpen);
      toggle.setAttribute('aria-expanded', String(stateOpen));
      setTimeout(()=> mapInstance.container.fitToViewport(), 120);
    }

    // Dastlab: default yopiq (sessionStorage bo'yicha eslash)
    const saved = sessionStorage.getItem(storageKey);
    const initialOpen = saved === '1' ? true : false;  // default false
    apply(initialOpen);

    // Toggle tugmasi
    toggle.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isOpen = !panel.classList.contains('is-collapsed');
      const next = !isOpen;
      apply(next);
      sessionStorage.setItem(storageKey, next ? '1' : '0');
    });

    // ‚úï tugmasi
    close.addEventListener('click', (e)=>{
      e.stopPropagation();
      apply(false);
      sessionStorage.setItem(storageKey, '0');
    });

    // Tashqariga bosilganda yopish (dropdown xulqi)
    document.addEventListener('click', (e)=>{
      const clickInsidePanel = panel.contains(e.target);
      const clickOnToggle = toggle.contains(e.target);
      const isOpen = !panel.classList.contains('is-collapsed');
      if (isOpen && !clickInsidePanel && !clickOnToggle){
        apply(false);
        sessionStorage.setItem(storageKey, '0');
      }
    });

    // Esc bilan yopish
    document.addEventListener('keydown', (e)=>{
      if (e.key === 'Escape'){
        apply(false);
        sessionStorage.setItem(storageKey, '0');
      }
    });
  }

  // === Kuryer biriktirish modal ===
  let currentOrderId = null;

  function openAssignModal(orderId, clientName, currentCourierId) {
    currentOrderId = orderId;
    const modal = document.getElementById('assignCourierModal');
    const select = document.getElementById('courierSelect');
    const title = document.getElementById('modalClientName');
    
    title.textContent = clientName;
    
    // Select ni to'ldirish
    select.innerHTML = '<option value="">-- Kuryerni olib tashlash --</option>';
    couriers.forEach(c => {
      const option = document.createElement('option');
      option.value = c.id;
      option.textContent = c.username;
      if (c.id === currentCourierId) {
        option.selected = true;
      }
      select.appendChild(option);
    });
    
    modal.classList.remove('hidden');
  }

  function closeAssignModal() {
    document.getElementById('assignCourierModal').classList.add('hidden');
    currentOrderId = null;
  }

  async function assignCourier() {
    const select = document.getElementById('courierSelect');
    const courierId = select.value || null;
    const errorDiv = document.getElementById('assignError');
    
    errorDiv.classList.add('hidden');
    
    try {
      const response = await fetch(`/orders/${currentOrderId}/assign-courier/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ courier_id: courierId })
      });
      
      const data = await response.json();
      
      if (data.success) {
        closeAssignModal();
        location.reload(); // Sahifani yangilash
      } else {
        errorDiv.textContent = data.error || 'Xatolik yuz berdi';
        errorDiv.classList.remove('hidden');
      }
    } catch (error) {
      errorDiv.textContent = 'Xatolik: ' + error.message;
      errorDiv.classList.remove('hidden');
    }
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // Global funksiyalar
  window.openAssignModal = openAssignModal;
  window.closeAssignModal = closeAssignModal;
  window.assignCourier = assignCourier;
  }
</script>
{% endblock %}
